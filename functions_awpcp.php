<?php
if(preg_match('#' . basename(__FILE__) . '#', $_SERVER['PHP_SELF'])) { die('You are not allowed to call this page directly.'); }
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Another Wordpress Classifieds Plugin: This file: functions_awpcp.php
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// START FUNCTION: retrieve individual options from settings table
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

function get_awpcp_option($option) {
	global $wpdb;
	$table_name4 = $wpdb->prefix . "awpcp_adsettings";
	$myreturn=0;
	$tableexists=checkfortable($table_name4);

	if($tableexists)
	{
		$query="SELECT config_value FROM  ".$table_name4." WHERE config_option='$option'";
		if (!($res=@mysql_query($query))) {trigger_error(mysql_error(),E_USER_ERROR);}
		if (mysql_num_rows($res))
		{
			$myreturn=mysql_result($res,0,0);
		}
	}
	return $myreturn;
}


////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// END FUNCTION
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// START FUNCTION: Check if the user is an admin
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


function checkifisadmin() {

	global $current_user;
	get_currentuserinfo();

$thisuserlevel=$current_user->user_level;

if(!isset($thisuserlevel) || empty($thisuserlevel)) {

if(is_admin()) {

	// This is assumptive and here because some users
	// run plugins that alter the wordpress user_level
	// structure thereby rendering $current_user->user_level
	// null and void

	$thisuserlevel = "10";

	}
}

	if($thisuserlevel == '10'){
		$isadmin=1;
	} else { $isadmin = 0; }

return $isadmin;

}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// END FUNCTION
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// START FUNCTION: Check if the admin has setup any listing fee options
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

function adtermsset(){

global $wpdb;
$table_name2 = $wpdb->prefix . "awpcp_adfees";

	$myreturn=false;
	$query="SELECT count(*) FROM ".$table_name2."";
	if (!($res=mysql_query($query))) {error(mysql_error(),__LINE__,__FILE__);}
	if (mysql_num_rows($res) && mysql_result($res,0,0)) {
		$myreturn=true;
	}
	return $myreturn;
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// END FUNCTION
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// START FUNCTION: Check if the admin has setup some categories
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

function categoriesexist(){

global $wpdb;
$table_name1 = $wpdb->prefix . "awpcp_categories";

	$myreturn=false;
	$query="SELECT count(*) FROM ".$table_name1."";
	if (!($res=mysql_query($query))) {error(mysql_error(),__LINE__,__FILE__);}
	if (mysql_num_rows($res) && mysql_result($res,0,0)) {
		$myreturn=true;
	}
	return $myreturn;
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// END FUNCTION
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// START FUNCTION: Count the total number of ads in the  system
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

function countlistings(){

global $wpdb;
$table_name3 = $wpdb->prefix . "awpcp_ads";

	$totallistings='';

	$query="SELECT count(*) FROM ".$table_name3."";
	if (!($res=mysql_query($query))) {trigger_error(mysql_error(),E_USER_ERROR);}
	while ($rsrow=mysql_fetch_row($res)) {
	 	list($totallistings)=$rsrow;
	}
	return $totallistings;
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// END FUNCTION
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// START FUNCTION: Count the total number of categories
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

function countcategories(){

global $wpdb;
$table_name1 = $wpdb->prefix . "awpcp_categories";

	$totalcategories='';

	$query="SELECT count(*) FROM ".$table_name1."";
	if (!($res=mysql_query($query))) {trigger_error(mysql_error(),E_USER_ERROR);}
	while ($rsrow=mysql_fetch_row($res)) {
	 	list($totalcategories)=$rsrow;
	}
	return $totalcategories;
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// END FUNCTION
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// START FUNCTION: Count parent categories
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

function countcategoriesparents(){

global $wpdb;
$table_name1 = $wpdb->prefix . "awpcp_categories";

	$totalparentcategories='';
	$query="SELECT count(*) FROM ".$table_name1." WHERE category_parent_id='0'";
	if (!($res=mysql_query($query))) {trigger_error(mysql_error(),E_USER_ERROR);}
	while ($rsrow=mysql_fetch_row($res)) {
	 	list($totalparentcategories)=$rsrow;
	}
	return $totalparentcategories;
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// END FUNCTION
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// START FUNCTION: Count children categories
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

function countcategorieschildren(){

global $wpdb;
$table_name1 = $wpdb->prefix . "awpcp_categories";

	$totalchildrencategories='';
	$query="SELECT count(*) FROM ".$table_name1." WHERE category_parent_id!='0'";
	if (!($res=mysql_query($query))) {trigger_error(mysql_error(),E_USER_ERROR);}
	while ($rsrow=mysql_fetch_row($res)) {
	 	list($totalchildrencategories)=$rsrow;
	}
	return $totalchildrencategories;
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// END FUNCTION
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// START FUNCTION: get number of images allowed per ad term id
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

function get_numimgsallowed($adtermid){
global $wpdb;
$table_name2 = $wpdb->prefix . "awpcp_adfees";
$imagesallowed='';
$query="SELECT imagesallowed FROM ".$table_name2." WHERE adterm_id='$adtermid'";
if (!($res=mysql_query($query))) {trigger_error(mysql_error(),E_USER_ERROR);}
	while ($rsrow=mysql_fetch_row($res)) {
	list($imagesallowed)=$rsrow;
	}
	return $imagesallowed;
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// END FUNCTION
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// START FUNCTION: Check to see how many images an ad is currently using
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

function get_total_imagesuploaded($ad_id) {

global $wpdb;
$table_name5 = $wpdb->prefix . "awpcp_adphotos";

$totalimagesuploaded='';

	$query="SELECT count(*) FROM ".$table_name5." WHERE ad_id='$ad_id'";
	if (!($res=mysql_query($query))) {trigger_error(mysql_error(),E_USER_ERROR);}
	while ($rsrow=mysql_fetch_row($res)) {
	 	list($totalimagesuploaded)=$rsrow;
	}
	return $totalimagesuploaded;

}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// END FUNCTION
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// START FUNCTION: Get the total number of images allowed depending on the ad term
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

function get_images_allowed($adterm) {
$imagesallowed='';
global $wpdb;
$table_name2 = $wpdb->prefix . "awpcp_adfees";

			 $query="SELECT imagesallowed from ".$table_name2." WHERE adterm_id='$adterm'";
			 if (!($res=@mysql_query($query))) {trigger_error(mysql_error(),E_USER_ERROR);}
 				while ($rsrow=mysql_fetch_row($res)) {
 					list($imagesallowed)=$rsrow;
				}
	return $imagesallowed;
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// END FUNCTION
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// START FUNCTION: Get the total number of days an ad term last based on term ID value
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

function get_num_days_in_term($adtermid) {
$numdaysinterm='';
global $wpdb;
$table_name2 = $wpdb->prefix . "awpcp_adfees";

			 $query="SELECT rec_period from ".$table_name2." WHERE adterm_id='$adtermid'";
			 if (!($res=@mysql_query($query))) {trigger_error(mysql_error(),E_USER_ERROR);}
 				while ($rsrow=mysql_fetch_row($res)) {
 					list($numdaysinterm)=$rsrow;
				}
	return $numdaysinterm;
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// END FUNCTION
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// START FUNCTION: Get the id for the ad term based on having the ad ID
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

function get_adterm_id($adid) {

global $wpdb;
$table_name3 = $wpdb->prefix . "awpcp_ads";

$adterm_id='';

			 $query="SELECT adterm_id from ".$table_name3." WHERE ad_id='$adid'";
			 if (!($res=@mysql_query($query))) {trigger_error(mysql_error(),E_USER_ERROR);}
 				while ($rsrow=mysql_fetch_row($res)) {
 					list($adterm_id)=$rsrow;
				}
	return $adterm_id;
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// END FUNCTION
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// START FUNCTION: Get the ad term name for the ad term based on having the ad term ID
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

function get_adterm_name($adterm_id) {

global $wpdb;
$table_name2 = $wpdb->prefix . "awpcp_adfees";

$adterm_name='';

			 $query="SELECT adterm_name from ".$table_name2." WHERE adterm_id='$adterm_id'";
			 if (!($res=@mysql_query($query))) {trigger_error(mysql_error(),E_USER_ERROR);}
 				while ($rsrow=mysql_fetch_row($res)) {
 					list($adterm_name)=$rsrow;
				}
	return $adterm_name;
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// END FUNCTION
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// START FUNCTION: Get the ad posters name based on having the ad ID
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

function get_adpostername($adid) {

global $wpdb;
$table_name3 = $wpdb->prefix . "awpcp_ads";

$adpostername='';
			 $query="SELECT ad_contact_name from ".$table_name3." WHERE ad_id='$adid'";
			 if (!($res=@mysql_query($query))) {trigger_error(mysql_error(),E_USER_ERROR);}
 				while ($rsrow=mysql_fetch_row($res)) {
 					list($adpostername)=$rsrow;
				}

	return $adpostername;
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// END FUNCTION
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// START FUNCTION: Get the ad posters access key based on given ID
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

function get_adkey($adid) {

global $wpdb;
$table_name3 = $wpdb->prefix . "awpcp_ads";

$adkey='';

			 $query="SELECT ad_key from ".$table_name3." WHERE ad_id='$adid'";
			 if (!($res=@mysql_query($query))) {trigger_error(mysql_error(),E_USER_ERROR);}
 				while ($rsrow=mysql_fetch_row($res)) {
 					list($adkey)=$rsrow;
				}
	return $adkey;
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// END FUNCTION
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// START FUNCTION: Get the ad title based on having the ad email
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

function get_adcontactbyem($email) {
$adcontact='';
global $wpdb;
$table_name3 = $wpdb->prefix . "awpcp_ads";

			 $query="SELECT ad_contact_name from ".$table_name3." WHERE ad_contact_email='$email'";
			 if (!($res=@mysql_query($query))) {trigger_error(mysql_error(),E_USER_ERROR);}
 				while ($rsrow=mysql_fetch_row($res)) {
 					list($adcontact)=$rsrow;
				}
	return $adcontact;

}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// END FUNCTION
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// START FUNCTION: Get the ad posters name based on having the ad email
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

function get_adtitlebyem($email) {
$adtitle='';
global $wpdb;
$table_name3 = $wpdb->prefix . "awpcp_ads";

			 $query="SELECT ad_title from ".$table_name3." WHERE ad_contact_email='$email'";
			 if (!($res=@mysql_query($query))) {trigger_error(mysql_error(),E_USER_ERROR);}
 				while ($rsrow=mysql_fetch_row($res)) {
 					list($adtitle)=$rsrow;
				}
	return $adtitle;

}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// END FUNCTION
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// START FUNCTION: Get the ad posters email based on having the ad ID
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

function get_adposteremail($adid) {

global $wpdb;
$table_name3 = $wpdb->prefix . "awpcp_ads";

$adposteremail='';

			 $query="SELECT ad_contact_email from ".$table_name3." WHERE ad_id='$adid'";
			 if (!($res=@mysql_query($query))) {trigger_error(mysql_error(),E_USER_ERROR);}
 				while ($rsrow=mysql_fetch_row($res)) {
 					list($adposteremail)=$rsrow;
				}
	return $adposteremail;
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// END FUNCTION
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// START FUNCTION: Get the ad title based on having the ad ID
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

function get_adtitle($adid) {

global $wpdb;
$table_name3 = $wpdb->prefix . "awpcp_ads";

$adtitle='';

			 $query="SELECT ad_title from ".$table_name3." WHERE ad_id='$adid'";
			 if (!($res=@mysql_query($query))) {trigger_error(mysql_error(),E_USER_ERROR);}
 				while ($rsrow=mysql_fetch_row($res)) {
 					list($adtitle)=$rsrow;
				}
	return $adtitle;
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// END FUNCTION
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// START FUNCTION: Get the ad term fee amount for the ad term based on having the ad term ID
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

function get_adfee_amount($adterm_id) {

global $wpdb;
$table_name2 = $wpdb->prefix . "awpcp_adfees";

$adterm_amount='';

			 $query="SELECT amount from ".$table_name2." WHERE adterm_id='$adterm_id'";
			 if (!($res=@mysql_query($query))) {trigger_error(mysql_error(),E_USER_ERROR);}
 				while ($rsrow=mysql_fetch_row($res)) {
 					list($adterm_amount)=$rsrow;
				}
	return $adterm_amount;
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// END FUNCTION: get ad term fee amount based on ad term ID
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// START FUNCTION: Create list of top level categories for admin category management
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


	function get_categorynameid($cat_id = 0,$cat_parent_id= 0,$exclude)
	{

		global $wpdb;
		$table_name1 = $wpdb->prefix . "awpcp_categories";

		if(isset($exclude) && !empty($exclude))
		{
			$excludequery="AND category_id !='$exclude'";
		}

	 	$catnid=$wpdb->get_results("select category_id as cat_ID, category_parent_id as cat_parent_ID, category_name as cat_name from ".$table_name1." WHERE category_parent_id='0' $excludequery");

	 	foreach($catnid as $categories)
	 	{

	  	if($categories->cat_ID == $cat_parent_id)
	   	{
	   		$optionitem .= "<option selected value='$categories->cat_ID'>$categories->cat_name</option>";
	   	}
	  	else
	   	{
	   		$optionitem .= "<option value='$categories->cat_ID'>$categories->cat_name</option>";
	   	}

	 	}

	 	return $optionitem;
	}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// END FUNCTION: create list of top level categories for admin category management
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// START FUNCTION: Create the list with both parent and child categories selection for ad post form
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

function get_categorynameidall($cat_id = 0)
		{

			global $wpdb;
			$table_name1 = $wpdb->prefix . "awpcp_categories";
			$optionitem='';

			// Start with the main categories

			$query="SELECT category_id,category_name FROM ".$table_name1." WHERE category_parent_id='0' ORDER BY category_name ASC";
			if (!($res=@mysql_query($query))) {trigger_error(mysql_error(),E_USER_ERROR);}

					while ($rsrow=mysql_fetch_row($res)) {

						$cat_ID=$rsrow[0];
						$cat_name=$rsrow[1];

						$opstyle="style=\"background-color:#eeeeee;margin-bottom:3px;\"";

						if($cat_ID == $cat_id)
						{
							$maincatoptionitem = "<option $opstyle selected value='$cat_ID'>$cat_name</option>";
						}
						else {
							$maincatoptionitem = "<option $opstyle value='$cat_ID'>$cat_name</option>";
						}

						$optionitem.="$maincatoptionitem";

						// While still looping through main categories get any sub categories of the main category

						$maincatid=$cat_ID;

		   					$query="SELECT category_id,category_name FROM ".$table_name1." WHERE category_parent_id='$maincatid' ORDER BY category_name ASC";
							if (!($res2=@mysql_query($query))) {trigger_error(mysql_error(),E_USER_ERROR);}

							while ($rsrow2=mysql_fetch_row($res2)) {


								$subcat_ID=$rsrow2[0];
								$subcat_name=$rsrow2[1];

								if($subcat_ID == $cat_id)
								{
									$subcatoptionitem = "<option selected value='$subcat_ID'>$subcat_name</option>";
								}
								else {
									$subcatoptionitem = "<option  value='$subcat_ID'>$subcat_name</option>";
								}

								$optionitem.="$subcatoptionitem";
							}
		   			}

		 	return $optionitem;
	}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// END FUNCTION: create drop down list of categories for ad post form
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// START FUNCTION: Retrieve the category name
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

	function get_adcatname($cat_ID){

			global $wpdb;
			$table_name1 = $wpdb->prefix . "awpcp_categories";

			if(isset($cat_ID) && (!empty($cat_ID))){
			 $query="SELECT category_name from ".$table_name1." WHERE category_id='$cat_ID'";
			 if (!($res=@mysql_query($query))) {trigger_error(mysql_error(),E_USER_ERROR);}
 				while ($rsrow=mysql_fetch_row($res)) {
 					list($cname)=$rsrow;
				}
			}
			return $cname;
	}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// END FUNCTION: get the category name
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// START FUNCTION: Retrieve the parent category name
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


		function get_adparentcatname($cat_ID){

			global $wpdb;
			$table_name1 = $wpdb->prefix . "awpcp_categories";
			$cname='';

			if($cat_ID == '0')
			{
				$cname="Top Level Category";
			}

			else
			{

				if(isset($cat_ID) && (!empty($cat_ID)))
				{
			 		$query="SELECT category_name from ".$table_name1." WHERE category_id='$cat_ID'";
			 		if (!($res=@mysql_query($query))) {trigger_error(mysql_error(),E_USER_ERROR);}

 						while ($rsrow=mysql_fetch_row($res))
 						{
 							list($cname)=$rsrow;
						}
				}
			}
			return $cname;
	}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// END FUNCTION: get the name of the category parent
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// START FUNCTION: Retrieve the parent category ID
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

	function get_cat_parent_ID($cat_ID){

			global $wpdb;
			$table_name1 = $wpdb->prefix . "awpcp_categories";

			if(isset($cat_ID) && (!empty($cat_ID))){
			 $query="SELECT category_parent_id from ".$table_name1." WHERE category_id='$cat_ID'";
			 if (!($res=@mysql_query($query))) {trigger_error(mysql_error(),E_USER_ERROR);}
 				while ($rsrow=mysql_fetch_row($res)) {
 					list($cpID)=$rsrow;
				}
			}
			return $cpID;
	}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// END FUNCTION: get the ID or the category parent
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// START FUNCTION: Check if the transaction ID coming back from paypal or 2checkout is a duplicate
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

function isdupetransid($transid){

global $wpdb;
$table_name3 = $wpdb->prefix . "awpcp_ads";

	$myreturn=false;
	$query="SELECT count(*) FROM ".$table_name3." WHERE ad_transaction_id='$transid'";
	if (!($res=mysql_query($query))) {error(mysql_error(),__LINE__,__FILE__);}
	if (mysql_num_rows($res) && mysql_result($res,0,0)) {
		$myreturn=true;
	}
	return $myreturn;
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// END FUNCTION: check if a transaction ID from paypal or 2checkout is already in the system
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// START FUNCTION: Check if there are any ads in the system
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


function ads_exist() {
global $wpdb;
$table_name3 = $wpdb->prefix . "awpcp_ads";
	$myreturn=false;
	$query="SELECT count(*) FROM ".$table_name3."";
	if (!($res=mysql_query($query))) {error(mysql_error(),__LINE__,__FILE__);}
	if (mysql_num_rows($res) && mysql_result($res,0,0)) {
		$myreturn=true;
	}
	return $myreturn;
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// END FUNCTION: check if any ads exist in the system
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// START FUNCTION: Check if there are any ads in a specified category
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


function ads_exist_cat($catid) {
global $wpdb;
$table_name3 = $wpdb->prefix . "awpcp_ads";
	$myreturn=false;
	$query="SELECT count(*) FROM ".$table_name3." WHERE ad_category_id='$catid' OR ad_category_parent_id='$catid'";
	if (!($res=mysql_query($query))) {error(mysql_error(),__LINE__,__FILE__);}
	if (mysql_num_rows($res) && mysql_result($res,0,0)) {
		$myreturn=true;
	}
	return $myreturn;
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// END FUNCTION: check if a category has ads
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// START FUNCTION: Check if the category has children
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


function category_has_children($catid) {
global $wpdb;
$table_name1 = $wpdb->prefix . "awpcp_categories";
	$myreturn=false;
	$query="SELECT count(*) FROM ".$table_name1." WHERE category_parent_id='$catid'";
	if (!($res=mysql_query($query))) {error(mysql_error(),__LINE__,__FILE__);}
	if (mysql_num_rows($res) && mysql_result($res,0,0)) {
		$myreturn=true;
	}
	return $myreturn;
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// END FUNCTION: check if a category has children
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// START FUNCTION: Check if the category is a child
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


function category_is_child($catid) {
global $wpdb;
$table_name1 = $wpdb->prefix . "awpcp_categories";
	$myreturn=false;

	$query="SELECT category_parent_id FROM ".$table_name1." WHERE category_id='$catid'";
	if (!($res=mysql_query($query))) {error(mysql_error(),__LINE__,__FILE__);}
		while ($rsrow=mysql_fetch_row($res)) {
 			list($cparentid)=$rsrow;
 			if( $cparentid != '0' )
 			{
 				$myreturn=true;
 			}
		}
	return $myreturn;
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// END FUNCTION: check if a category is a child
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// START FUNCTION: Check how many ads a category contains
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


function total_ads_in_cat($catid) {
global $wpdb;
$table_name3 = $wpdb->prefix . "awpcp_ads";
	$totaladsincat='';


		if((get_awpcp_option('disablependingads') == 1)  && (get_awpcp_option('freepay') == 1)){
				$filter=" AND payment_status != 'Pending'";
			}


	$query="SELECT count(*) FROM ".$table_name3." WHERE (ad_category_id='$catid' OR ad_category_parent_id='$catid') AND disabled = '0' $filter";
	if (!($res=mysql_query($query))) {error(mysql_error(),__LINE__,__FILE__);}
 	while ($rsrow=mysql_fetch_row($res)) {
 		list($totaladsincat)=$rsrow;
	}
	return $totaladsincat;
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// END FUNCTION: check how many ads are in a category
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// START FUNCTION: Check if there are any ads in the system
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


function images_exist() {
global $wpdb;
$table_name5 = $wpdb->prefix . "awpcp_ads";
	$myreturn=false;
	$query="SELECT count(*) FROM ".$table_name5."";
	if (!($res=mysql_query($query))) {error(mysql_error(),__LINE__,__FILE__);}
	if (mysql_num_rows($res) && mysql_result($res,0,0)) {
		$myreturn=true;
	}
	return $myreturn;
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// END FUNCTION: Check if images exist in system
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// START FUNCTION: Eemove unwanted characters from string and setup for use with search engine friendly urls
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

function cleanstring($text)
{

$code_entities_match = array(' ','--','&quot;','!','@','#','$','%','^','&','*','(',')','+','{','}','|',':','"','<','>','?','[',']','\\',';',"'",',','.','/','*','+','~','`','=');
$code_entities_replace = array('_','_','','','','','','','','','','','','','','','','','','','','','','','');
$text = str_replace($code_entities_match, $code_entities_replace, $text);
if (version_compare(PHP_VERSION, '5.2.0', '>=')) {
	$text="".(filter_var($text, FILTER_SANITIZE_URL))."";
}
return $text;
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// END FUNCTION: remove unwanted characters from string to be used in URL for search engine friendliness
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// START FUNCTION: replace underscores with dashes for search engine friendly urls
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

function add_dashes($text) {
$text=str_replace("_","-",$text);
return $text;
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// END FUNCTION: replace underscores with dashes for search engine friendly urls
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// START FUNCTION: get the page ID when the page name is known
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

// Get the id of a page by its name
function get_page_id($awpcppagename){
	global $wpdb;
	$awpcpwppostpageid = $wpdb->get_var("SELECT ID FROM $wpdb->posts WHERE post_name = '$awpcppagename'");
	return $awpcpwppostpageid;
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// END FUNCTION: Get the ID from wordpress posts table where the post_name is known
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// START FUNCTION: setup the structure of the URLs based on if permalinks are on and SEO urls are turned on
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

function setup_url_structure($awpcppagename) {


			$quers='';
			$theblogurl=get_bloginfo('url');


			$permastruc=get_option('permalink_structure');

			if( strstr($permastruc,'index.php') )
			{
				$theblogurl.="/index.php";
			}

			//Get the ID of the classifieds page
			$awpcpwppostpageid=get_page_id($awpcppagename);


			// Get the parent ID of the classifieds page in order to check if the page is or is not a child
			$awpcppageparentid=get_page_parent_id($awpcpwppostpageid);

			if($awpcppageparentid == '0')
			{
				//The page is not a child so do nothing
				$awpcpparentpagename='';
			}
			elseif($awpcppageparentid >= '1')
			{
				// The page has a parent so get the parent page name and append to siteurl
				$awpcpparentpagename=get_awpcp_parent_page_name($awpcppageparentid);
				$theblogurl.="/$awpcpparentpagename";
			}

			if(!isset($permastruc) || empty($permastruc))
			{
				$quers="$theblogurl?page_id=$awpcpwppostpageid&a=";
			}
			elseif(get_awpcp_option('seofriendlyurls') == '1'){
				$quers="$theblogurl/$awpcppagename/";
			}
			else {

				$quers="$theblogurl/$awpcppagename/?a=";
			}

			return $quers;
		}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// END FUNCTION: setup structure of URLs based on if permalinks are on and SEO urls are turned on
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// START FUNCTION: get the parent_id of the post
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

function get_page_parent_id($awpcpwppostpageid){
	global $wpdb;
	$awpcppageparentid = $wpdb->get_var("SELECT post_parent FROM $wpdb->posts WHERE ID = '$awpcpwppostpageid'");
	return $awpcppageparentid;
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// END FUNCTION: get the parent id of a wordpress post where the post ID is known
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// START FUNCTION: get the name of a wordpress entry from table posts where the parent id is present
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

function get_awpcp_parent_page_name($awpcppageparentid) {

	global $wpdb;
	$awpcpparentpagename = $wpdb->get_var("SELECT post_name FROM $wpdb->posts WHERE ID = '$awpcppageparentid'");
	return $awpcpparentpagename;


}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// END FUNCTION: get the name of a wordpress wp_post entry where the ID of the post parent is present
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// START FUNCTION: check if a specific database table exists
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

function checkfortable($table) {

		$tableexists=false;
		$query="SELECT count(*) FROM ".$table."";
		if (($res=mysql_query($query))) {
			$tableexists=true;
		}

		return $tableexists;
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// END FUNCTION: check if a specific database table exists
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// START FUNCTION: get the current name of the classfieds page
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


function get_currentpagename() {
global $wpdb;
$table_name6 = $wpdb->prefix . "awpcp_pagename";

$tableexists=checkfortable($table_name6);

		if(!$tableexists){
			$currentpagename='';
		}

		else {

			 $query="SELECT userpagename from ".$table_name6."";
			 if (!($res=@mysql_query($query))) {trigger_error(mysql_error(),E_USER_ERROR);}
 				while ($rsrow=mysql_fetch_row($res)) {
 					list($currentpagename)=$rsrow;
				}
		}

			return $currentpagename;

}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// END FUNCTION: query awpcp_pagename for the name being used for the classifieds site
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// START FUNCTION: delete the classfied page name from database as needed
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

function deleteuserpageentry($currentuipagename) {

global $wpdb;
$table_name6 = $wpdb->prefix . "awpcp_pagename";

			 $query="TRUNCATE ".$table_name6."";
			 if (!($res=@mysql_query($query))) {trigger_error(mysql_error(),E_USER_ERROR);}
			 mysql_query($query);
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// END FUNCTION: delete the user page entry from awpcp_pagename table
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// START FUNCTION: check if the classifieds page exists in the wp posts table
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

function findpage($pagename) {

global $wpdb,$table_prefix;
$myreturn=false;

			 $query="SELECT post_title FROM {$table_prefix}posts WHERE post_title='$pagename'";
			 if (!($res=@mysql_query($query))) {trigger_error(mysql_error(),E_USER_ERROR);}
				if (mysql_num_rows($res) && mysql_result($res,0,0)) {
					$myreturn=true;
			}
			return $myreturn;

}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// END FUNCTION: check if classifieds page exists
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


function printmessage($message){

	if(isset($message) && !empty($message)){
		echo "$message";
		die;
	}
	else {
		echo "There is a small problem. You have just completed a task but the system is confused about how to respond as it has received no message to relay to you.Please check to make sure you successfully completed what you were trying to do";
		die;
	}

}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// START FUNCTION: check ad_settings to see if a particular function exists to prevent duplicate entery when updating plugin
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

function field_exists($field){
global $wpdb;
$table_name4 = $wpdb->prefix . "awpcp_adsettings";

			 $query="SELECT config_value FROM  ".$table_name4." WHERE config_option='$field'";
			 	if (!($res=@mysql_query($query))) {trigger_error(mysql_error(),E_USER_ERROR);}
			 	if (mysql_num_rows($res)) {
				$myreturn=true;
			} else { $myreturn=false; }

	return $myreturn;
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// END FUNCTION: check if ad_settings field exists
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// START FUNCTION: a general functin to shorten text to summary or excerpt
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

function awpcpLimitText($Text,$Min,$Max,$MinAddChar) {
	    if (strlen($Text) < $Min) {
	        $Limit = $Min-strlen($Text);
	        $Text .= $MinAddChar;
	    }
	    elseif (strlen($Text) >= $Max) {
	        $words = explode(" ", $Text);
	        $check=1;
	        while (strlen($Text) >= $Max) {
	            $c=count($words)-$check;
	            $Text=substr($Text,0,(strlen($words[$c])+1)*(-1));
	            $check++;
	        }
	    }

	    return $Text;
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// END FUNCTION: limit text
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// START FUNCTION: function to handle automatic ad expirations
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


function doadexpirations(){

	global $wpdb,$nameofsite,$siteurl,$thisadminemail;
	$table_name3 = $wpdb->prefix . "awpcp_ads";
	$table_name5 = $wpdb->prefix . "awpcp_adphotos";
	$headers="From: $thisadminemail";

	// Get the IDs of the ads to be deleted
	$query="SELECT ad_id FROM ".$table_name3." WHERE ad_enddate < CURDATE()";
	if (!($res=mysql_query($query))) {die(mysql_error());}

	$expiredid=array();

	if (mysql_num_rows($res)) {

	 	while ($rsrow=mysql_fetch_row($res)) {
 			$expiredid[]=$rsrow[0];

		}
		$totalusers=count($expiredid);
	}

				$adstodelete=join("','",$expiredid);
				// Delete the ad images

					$query="SELECT image_name FROM ".$table_name5." WHERE ad_id IN ('$adstodelete')";
					if (!($res=@mysql_query($query))) {trigger_error(mysql_error(),E_USER_ERROR);}

					for ($i=0;$i<mysql_num_rows($res);$i++) {
					$photo=mysql_result($res,$i,0);

						if (file_exists(AWPCPUPLOADDIR.'/'.$photo)) {
							@unlink(AWPCPUPLOADDIR.'/'.$photo);
						}
						if (file_exists(AWPCPTHUMBSUPLOADDIR.'/'.$photo)) {
							@unlink(AWPCPTHUMBSUPLOADDIR.'/'.$photo);
						}
					}

					$query="DELETE FROM ".$table_name5." WHERE ad_id IN ('$adstodelete')";
					if (!($res=@mysql_query($query))) {trigger_error(mysql_error(),E_USER_ERROR);}


					// Delete the ads


					$query="DELETE FROM ".$table_name3." WHERE ad_id IN ('$adstodelete')";
					@mysql_query($query);

					// Send out an email notifying users that their ad has been deleted if notify is on

					if(get_awpcp_option('notifyofadexpiring') == '1'){

							foreach ($expiredid as $adid) {

								$adcontact=get_adpostername($adid);
								$email=get_adposteremail($adid);
								$adtitle=get_adtitle($adid);

								$subject="Your classifieds listing at $nameofsite has expired";
								$body="Dear $adcontact<br><br>";
								$body.="This is an automated notification that your ad titled <b>$adtitle</b> posted at $nameofsite has expired.";
								$body.="$siteurl";

							//mail($email,$subject,$body,$headers);
							send_email($thisadminemail,$email,$subject,$body,true);

							}



					}

}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// END FUNCTION: process auto ad expiration
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// START FUNCTION: Function to check for the existence of a default category with a category ID of 1 (used with mass category deletion)
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

function defaultcatexists($defid) {



global $wpdb;
$table_name1 = $wpdb->prefix . "awpcp_categories";

	$myreturn=false;
		$query="SELECT * FROM ".$table_name1." WHERE category_id='$defid'";
		if (!($res=mysql_query($query))) {error(mysql_error(),__LINE__,__FILE__);}
		if (mysql_num_rows($res)) {
			$myreturn=true;
		}

	return $myreturn;

}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// END FUNCTION: check if default category exists
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// START FUNCTION: function to create a default category with an ID of  1 in the event a default category with ID 1 does not exist
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

function createdefaultcategory($idtomake,$titletocallit) {

		global $wpdb;
		$table_name1 = $wpdb->prefix . "awpcp_categories";

		$query="INSERT INTO ".$table_name1." SET category_name='$titletocallit',category_parent_id='0'";
	 	if (!($res=@mysql_query($query))) {trigger_error(mysql_error(),E_USER_ERROR);}
	 	$newdefid=mysql_insert_id();

	 	$query="UPDATE ".$table_name1." SET category_id='1' WHERE category_id='$newdefid'";
		if (!($res=@mysql_query($query))) {trigger_error(mysql_error(),E_USER_ERROR);}
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// END FUNCTION: create default category
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// START FUNCTION: function to delete multiple ads at once used when admin deletes a category that contains ads but does not move the ads to a new category
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

function massdeleteadsfromcategory($catid){

	global $wpdb,$nameofsite,$siteurl,$thisadminemail;
	$table_name3 = $wpdb->prefix . "awpcp_ads";
	$table_name5 = $wpdb->prefix . "awpcp_adphotos";

	// Get the IDs of the ads to be deleted
	$query="SELECT ad_id FROM ".$table_name3." WHERE ad_category_id='$catid'";
	if (!($res=@mysql_query($query))) {trigger_error(mysql_error(),E_USER_ERROR);}

	$fordeletionid=array();

	if (mysql_num_rows($res)) {

	 	while ($rsrow=mysql_fetch_row($res)) {
 			$fordeletionid[]=$rsrow[0];

		}
		$totalusers=count($fordeletionid);
	}

				$adstodelete=join("','",$fordeletionid);
				// Delete the ad images

					$query="SELECT image_name FROM ".$table_name5." WHERE ad_id IN ('$adstodelete')";
					@mysql_query($query);

					for ($i=0;$i<mysql_num_rows($res);$i++) {
					$photo=mysql_result($res,$i,0);

						if (file_exists(AWPCPUPLOADDIR.'/'.$photo)) {
							@unlink(AWPCPUPLOADDIR.'/'.$photo);
						}
						if (file_exists(AWPCPTHUMBSUPLOADDIR.'/'.$photo)) {
							@unlink(AWPCPTHUMBSUPLOADDIR.'/'.$photo);
						}
					}

					$query="DELETE FROM ".$table_name5." WHERE ad_id IN ('$adstodelete')";
					@mysql_query($query);


					// Delete the ads

					$query="DELETE FROM ".$table_name3." WHERE ad_id IN ('$adstodelete')";
					@mysql_query($query);


}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// END FUNCTION: mass delete ads
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// START FUNCTION: The sidebar widget to show latest sidebar ads
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
### Function: Init AWPCP Latest Classified Headlines Widget
function init_awpcpsbarwidget() {
	if (!function_exists('register_sidebar_widget')) {
		return;
	}

	### Function: AWPCP Latest Classified Headlines Widget
	function widget_awpcplatestads($args) {
		extract($args);
		$options = get_option('widget_awpcplatestads');
		$title = htmlspecialchars(stripslashes($options['title']));
		$limit = htmlspecialchars(stripslashes($options['hlimit']));
		if(ads_exist()){
			echo $before_widget.$before_title.$title.$after_title;
			if (function_exists('awpcp_sidebar_headlines')) {
				echo '<ul>'."\n";
				awpcp_sidebar_headlines($limit);
				echo '</ul>'."\n";
			}
			echo $after_widget;
		}
	}

	### Function: AWPCP Latest Classified Headlines Widget Options
	function widget_awpcplatestads_options() {
		$options = get_option('widget_awpcplatestads');
		if (!is_array($options)) {
			$options = array('hlimit' => '10', 'title' => __('Latest Classifieds', 'wp-awpcplatestads'));
		}
		if ($_POST['awpcplatestads-submit']) {
			$options['hlimit'] = intval($_POST['awpcpwid-limit']);
			$options['title'] = strip_tags($_POST['awpcpwid-title']);
			update_option('widget_awpcplatestads', $options);
		}
		echo '<p><label for="awpcpwid-title">'.__('Widget Title', 'wp-awpcplatestads').':</label>&nbsp;&nbsp;&nbsp;<input type="text" id="awpcpwid-title" size="35" name="awpcpwid-title" value="'.htmlspecialchars(stripslashes($options['title'])).'" />';
		echo '<p><label for="awpcpwid-limit">'.__('Number of headlines to Show', 'wp-awpcplatestads').':</label>&nbsp;&nbsp;&nbsp;<input type="text" size="5" id="awpcpwid-limit" name="awpcpwid-limit" value="'.htmlspecialchars(stripslashes($options['hlimit'])).'" />';
		echo '<input type="hidden" id="awpcplatestads-submit" name="awpcplatestads-submit" value="1" />'."\n";
	}

	// Register Widgets
	register_sidebar_widget('AWPCPClassifieds', 'widget_awpcplatestads');
	register_widget_control('AWPCPClassifieds', 'widget_awpcplatestads_options', 350, 120);

}

function awpcp_sidebar_headlines($limit) {

global $wpdb;
$table_name3 = $wpdb->prefix . "awpcp_ads";


$awpcppage=get_currentpagename();
$awpcppagename = sanitize_title($awpcppage, $post_ID='');
$permastruc=get_option('permalink_structure');
$quers=setup_url_structure($awpcppagename);

if(!isset($limit) || empty ($limit)){
$limit=10;}

			$query="SELECT ad_id,ad_title FROM ".$table_name3." WHERE ad_title <> '' AND disabled = '0' ORDER BY ad_postdate DESC LIMIT ".$limit."";
			if (!($res=@mysql_query($query))) {trigger_error(mysql_error(),E_USER_ERROR);}

			while ($rsrow=mysql_fetch_row($res)) {
				$ad_id=$rsrow[0];
				$modtitle=cleanstring($rsrow[1]);
				$modtitle=add_dashes($modtitle);

					if(get_awpcp_option('seofriendlyurls') == '1'){
						if(isset($permastruc) && !empty($permastruc)){
						$ad_title="<a href=\"".$quers."showad/$ad_id/$modtitle\">".$rsrow[1]."</a>";
						}
						else {
						$ad_title="<a href=\"".$quers."showad&id=$ad_id\">".$rsrow[1]."</a>";
						}
					}
					else {
						$ad_title="<a href=\"".$quers."showad&id=$ad_id\">".$rsrow[1]."</a>";
					}

			echo "<li>$ad_title</li>";

			}

}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// END FUNCTION: sidebar widget
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// START FUNCTION: make sure there's not more than one page with the name of the classifieds page
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


function checkfortotalpageswithawpcpname($awpcppage) {

$awpcppagename = sanitize_title($awpcppage, $post_ID='');

	$pageswithawpcpname=array();
	global $wpdb,$table_prefix;

	$query="SELECT ID FROM $wpdb->posts WHERE post_title='$awpcppage' AND post_name = '$awpcppagename'";
	if (!($res=@mysql_query($query))) {trigger_error(mysql_error(),E_USER_ERROR);}

	if (mysql_num_rows($res))
	{
	 	while ($rsrow=mysql_fetch_row($res))
	 	{
	 		$pageswithawpcpname[]=$rsrow[0];
	 	}
	 	$totalpageswithawpcpname=count($pageswithawpcpname);
	}

	if( $totalpageswithawpcpname > 1 )
	{

		foreach ( $pageswithawpcpname as $pagewithawpcpname )
		{

			//Delete the pages
			$query="DELETE FROM {$table_prefix}posts WHERE ID = '$pagewithawpcpname'";
			@mysql_query($query);

		}

			deleteuserpageentry($awpcppage);

	}
}


/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// END FUNCTION: make sure there's not more than one page with the name of the classifieds page
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// START FUNCTION: check a specific ad to see if it is disabled or enabled
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

function check_if_ad_is_disabled($adid) {
global $wpdb;
$table_name3 = $wpdb->prefix . "awpcp_ads";

	$myreturn=false;
		$query="SELECT disabled FROM ".$table_name3." WHERE ad_id='$adid'";
		if (!($res=mysql_query($query))) {error(mysql_error(),__LINE__,__FILE__);}

			while ($rsrow=mysql_fetch_row($res))
			{
		 		list($adstatusdisabled)=$rsrow;
			}
				if ($adstatusdisabled == 1)
				{
					$myreturn=true;
				}

	return $myreturn;

}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// END FUNCTION: check a specific ad to see if it is disabled or enabled
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

if ( !function_exists( 'property_exists' ) ) {
    function property_exists( $class, $property ) {
        if ( is_object( $class ) ) {
            $vars = get_object_vars( $class );
        } else {
            $vars = get_class_vars( $class );
        }
        return array_key_exists( $property, $vars );
    }
}


/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// START FUNCTION: Clear HTML tags
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


function strip_html_tags( $text )
{
    $text = preg_replace(
        array(
          // Remove invisible content
            '@<head[^>]*?>.*?</head>@siu',
            '@<style[^>]*?>.*?</style>@siu',
            '@<script[^>]*?.*?</script>@siu',
            '@<object[^>]*?.*?</object>@siu',
            '@<embed[^>]*?.*?</embed>@siu',
            '@<applet[^>]*?.*?</applet>@siu',
            '@<noframes[^>]*?.*?</noframes>@siu',
            '@<noscript[^>]*?.*?</noscript>@siu',
            '@<noembed[^>]*?.*?</noembed>@siu',
          // Add line breaks before and after blocks
            '@</?((address)|(blockquote)|(center)|(del))@iu',
            '@</?((div)|(h[1-9])|(ins)|(isindex)|(p)|(pre))@iu',
            '@</?((dir)|(dl)|(dt)|(dd)|(li)|(menu)|(ol)|(ul))@iu',
            '@</?((table)|(th)|(td)|(caption))@iu',
            '@</?((form)|(button)|(fieldset)|(legend)|(input))@iu',
            '@</?((label)|(select)|(optgroup)|(option)|(textarea))@iu',
            '@</?((frameset)|(frame)|(iframe))@iu',
        ),
        array(
            ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ',
            "\n\$0", "\n\$0", "\n\$0", "\n\$0", "\n\$0", "\n\$0",
            "\n\$0", "\n\$0",
        ),
        $text );
    return strip_tags( $text );
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// END FUNCTION
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

?>
